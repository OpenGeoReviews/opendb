<!DOCTYPE html>
<html>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="../js/jquery.json-editor.min.js"></script>
<style>
    body {padding: 40px; }
    li {
        list-style-type: none;
    }
</style>
</head>
<head>
</head>

<body>
<p id="result"></p>
<ul class="nav nav-tabs" id="tabspanel">
    <li class="active"><a data-toggle="tab" href="#home">Status</a></li>
    <li><a data-toggle="tab" href="#blocks" id="blocks-tab">Blocks</a></li>
    <li><a data-toggle="tab" href="#operations" id="operations-tab">Operations</a></li>
    <li><a data-toggle="tab" href="#objects" id="objects-tab">Objects</a></li>
    <li><a data-toggle="tab" href="#errors" id="errors-tab">Errors</a></li>
    <li><a data-toggle="tab" href="#api" id="api-tab">API</a></li>
    <li><a data-toggle="tab" href="#settings" id="settings-tab">Settings</a></li>
    <li><a data-toggle="tab" href="#metrics" id="metrics-tab">Metrics</a></li>
    <li><a data-toggle="tab" href="#ipfs" id="ipfs-tab">IPFS</a></li>
    <li><a data-toggle="tab" href="#reg" id="reg-tab">Registration</a></li>
</ul>
<div class="tab-content">
    <div id="home" class="tab-pane fade in active">
        <h1>Admin harness for OpenDB</h1>
        <div class="form-group">
            <p>Blockchain status: <b><span id="blockchain-status"></span></b></p>
            <p>Admin server user: <b><span id="admin-user"></span></b></p>
            <p>Admin logged in user: <b><span id="admin-login-user">not logged in</span></b></p>
            <p>Superblocks: <ol class="breadcrumb" id="blockchain-blocks"></ol></p>
            <p id="blockchain-orphaned-blocks-header">Orphaned blocks: <b><span id="blockchain-orphaned-blocks"></span></b></p>
            
		</div>
        <div id="admin-login-div">
            <div class="form-inline">
                <label for="admin-login-name">Login:</label>
                <input type="text" class="form-control" id="admin-login-name"/>
                <label for="admin-login-key">Key:</label>
                <input type="password" class="form-control" id="admin-login-key"/>
                <input type="button" class="btn btn-primary" value="Login as admin" id="admin-login-btn"/>
            </div>
        </div>
        <div id="admin-actions" >
        	<div class="panel panel-success">
        		<div class="panel-heading"><b>Block actions</b></div>
        		<div class="panel-body">
            		<div class="form-inline">
            			<input type="button" class="btn btn-primary form-control" value="Create block" id="block-create-btn"/>
            			<input type="button" class="btn btn-primary form-control" value="Replicate blocks" id="replicate-btn" />
            			<input type="button" class="btn btn-primary form-control" value="Compact superblocks" id="compact-btn" />
            		</div>
            	</div>
            </div>
            <div class="panel panel-success">
        		<div class="panel-heading"><b>Blockchain actions</b></div>
        		<div class="panel-body">
            		<div class="form-inline">
            			<input type="button" class="btn btn-primary form-control" value="Clear log" id="clear-log-btn" />
            			<input type="button" class="btn btn-primary form-control" value="Lock/unlock blockchain" id="ops-pause-btn"/>
            			<input type="button" class="btn btn-primary form-control" value="Pause/start new blocks" id="blocks-pause-btn"/>
            			<input type="button" class="btn btn-primary form-control" value="Pause/start replication" id="replicate-pause-btn"/>
            		</div>
            	</div>
            </div>
			
        </div>
        <div id="owner-actions">
        	<div class="panel panel-warning">
        		<div class="panel-heading"><b>Management actions</b></div>
        		<div class="panel-body">
            		<div class="form-inline">
            			<input type="button" class="btn btn-primary form-control" value="Bootstrap" id="block-bootstrap-btn"/>
                		<input type="button" class="btn btn-primary form-control" value="Revert super block" id="block-revert-btn"/>
                		<input type="button" class="btn btn-primary form-control" value="Revert 1 block" id="block-1revert-btn"/>
            		</div>
            	</div>
            </div>
        	<div class="panel panel-warning">
        		<div class="panel-heading"><b>Delete actions</b></div>
        		<div class="panel-body">
            		<div class="form-inline">
            			<input type="button" class="btn btn-primary form-control" value="Clear queue" id="clear-list-btn" />
            			<input type="text" class="form-control" id="remove-orphaned-blocks-txt"/>
            			<input type="button" class="btn btn-primary" value="Remove orphaned blocks" id="remove-orphaned-blocks-btn"/>
            			<input type="text" class="form-control" id="remove-queue-ops-txt"/>
            			<input type="button" class="btn btn-primary" value="Remove queue operations" id="remove-queue-ops-btn"/>
            		</div>
            	</div>
            </div>
        </div>
    </div>

    <div id="blocks" class="tab-pane fade">
        <h3>Blocks</h3>
        <div class="row form-group form-horizontal">
        	<div class="col-md-3">
            	<select id="blocks-search" class="form-control">
					<option selected value="all">All blocks</option>
					<option value="from">Blocks from</option>
					<option value="to">Blocks to</option>
            	</select>
            </div>
            <div class="col-md-3" hidden="true" id="block-from-fields" >
                <input type="text" id="search-block-field" class="form-control" placeholder="Start block" aria-label="Block hash">
            </div>
           	<label id="blocks-limit" for="block-limit-value" class="control-label col-md-1">Limit</label>
            <div class="col-md-2">
               	<input type="text" id="block-limit-value" class="form-control" placeholder="Limit-value" aria-label="Number of blocks">
            </div>
        </div>
        <div class="row form-group">
        	<div class="col-md-2">
        		<input type="button" class="btn btn-primary form-control" id="block-load-btn" value="Load">
        	</div>
        </div>
        <ul class="list-group" id="blocks-list">
        </ul>
        <ul class="list-group" hidden="true" id="blocks-list-item">
        	<li class="panel panel-default">
        		<div class="panel-heading">
        			<b><a did="block-operation-link" href="#" onclick="">Block <span did="block-id"></span></a></b>
        			<span class="pull-right"  did="block-hash"></span>
        		</div>
        		<div class="panel-body">
                    <p>Date: <b><span did="block-date"></span></b></p>
                    <p class="pull-right">Signed by: <b><span did="signed-by"> </span></b></p>
                    <p><span did="block-objects-info"></span></p>
                    <details><summary><b>More</b></summary>
                        <pre>
Previous block hash: <b><span did="prev-block-hash"></span></b>
Superblock: <b><span did="superblock"></span></b>
Operations: <b><span did="op-count"></span></b>
Added/Edited/Removed objects: <b><span did="block-objects"></span></b>
Block size: <b><span did="block-size"></span></b>
Merkle tree hash: <b><span did="merkle-tree"></span></b>
Details: <b><span did="block-details"></span></b></pre>
                    </details>
                    <details><summary><b>Raw json</b></summary><pre did="block-json"></pre></details>
        		</div>
        	</li>
        </ul>
        

    </div>

    <div id="operations" class="tab-pane fade">
        <h3>Operations</h3>
        <div class="row form-group form-horizontal">
            <!--<label for="operations-search" class="control-label col-md-1">Select load:&nbsp;</label>-->
            <div class="col-md-3">
                <select id="operations-search" class="form-control">
                    <option selected value="queue">Queue</option>
                    <option value="id">by Id</option>
                    <option value="blockId">by Block Id</option>
                    <option value="blockHash">by Block Hash</option>
                </select>
            </div>
            <div hidden="true" id="operations-search-fields">
                <label id="input-search-operation-key" for="operations-key" class="control-label col-md-1">Input</label>
                <div class="col-md-3">
                    <input type="text" id="operations-key" class="form-control">
                </div>
            </div>
        </div>
        <div class="row form-group">
            <div class="col-md-2">
                <input type="button" id="operations-search-btn" value="Load" class="btn btn-primary form-control">
            </div>
        </div>
        <label id="amount-operations" class="col-form-label" hidden="true"></label>
        <ul class="list-group" id="operations-list"></ul>
        <ul class="list-group" hidden="true" id="operation-list-item">
            <li class="panel panel-default">
                <div class="panel-heading">
                    <b><a class="pull-right" did="operation-object-link" href="#" ><span did="op-hash"></span></a></b>
                    <p>Operation type: <b><span did="op-type"></span></b></p>
                </div>
                <div class="panel-body">
                    <p class="pull-right">Signed by: <b><span did="signed-by"></span></b></p>
                    <p>Objects: <span did="object-info"></span></p>
                    <details><summary><b>Raw json</b></summary><pre did="op-json"></pre></details>
                </div>
            </li>
        </ul>
    </div>

    <div id="objects" class="tab-pane fade">
        <h3>Objects</h3>

        <div class="form-group">
        <form class="form-inline">
            <div class="form-group">
                <label for="type-list">Select type:&nbsp;</label>
                <select class="form-control" id="type-list"></select>
            </div>
            <div class="form-group">
                <label for="search-type-list">Search:&nbsp;</label>
                <select class="form-control" id="search-type-list">
                    <option selected value="all">all</option>
                    <option value="userId">by userId</option>
                    <option value = "opHash" >by opHash</option>
                </select>
            </div>
            <div class="form-group">
                <label for="historyCheckbox">Show history</label>
                <input type="checkbox" id="historyCheckbox" name="scales">
            </div>
        </form>
        </div>

        <div class="form-group">
        <form class="form-inline" id="search-key-input" hidden="true">
            <div class="form-group">
                <label for="search-key" id="name-key-field"></label>
                <input type="text" id="search-key" class="form-control"/>
            </div>
        </form>
        </div>

        <div class="form-group">
            <form class="form-inline">
                <div class="form-group">
                    <label for="limit-field">Amount entries (Limit):</label>
                    <input type="text" class="form-control" id="limit-field" value="50"/>
                </div>
            </form>
        </div>

        <div class="row form-group">
            <div class="col-md-2">
                <input type="submit" value="Search" id="load-objects-btn" class="btn btn-primary form-control">
            </div>
        </div>

        <label class="col-form-label" id="amount-objects"></label>
        <pre id="json-display" hidden="true"></pre>

        <div class="col-12 row">
            <div id="stop-edit-objects" class="col-md-1" hidden="true">
                <input type="button" value="Stop edit" id="stop-edit-btn" class="btn btn-primary">
            </div>
            <div id="editing-objects" class="col-md-1" hidden="true">
                <input type="button" value="Finish edit" id="finish-edit-btn" class="btn btn-primary">
            </div>
            <div id="add-edited-obj" class="col-md-1" hidden="true">
                <input type="button" value="Add edit op" id="add-edit-op-btn" class="btn btn-primary">
            </div>
        </div>

        <ul class="list-group" id="objects-list"></ul>
        <ul class="list-group" id="objects-list-item" hidden="true">
            <li class="panel panel-default">
                <div class="panel-heading">
                    <b><span class="pull-right" did="op-hash"></span></b>
                    <p>Object ID: <b><span did="obj-id"></span></b></p>
                </div>
                <div class="panel-body">
                    <p did="comment">Comment: <b><span did="obj-comment"></span></b></p>
                    <details><summary><b>Raw json</b></summary><pre did="object-json"></pre></details>
                </div>
            </li>
        </ul>
        <ul class="list-group" id="objects-history-list-item" hidden="true">
            <li class="panel panel-default">
                <div class="panel-heading">
                    <b><a class="pull-right" did="operation-object-link" href="#" ><span did="op-hash"></span></a></b>
                    <p>Object ID: <b><span did="obj-id"></span></b></p>
                </div>
                <div class="panel-body">
                    <!--<p class="pull-right">Signed by: <b><span did="signed-by"></span></b></p>-->
                    <p>Comment: <b><span did="obj-comment"></span></b></p>
                    <p>Comment: <b><span did="obj-comment"></span></b></p>
                    <p>Comment: <b><span did="obj-comment"></span></b></p>
                    <p>Comment: <b><span did="obj-comment"></span></b></p>
                    <p>Comment: <b><span did="obj-comment"></span></b></p>
                    <details><summary><b>Raw json</b></summary><pre did="object-json"></pre></details>
                    <details><summary><b>Raw json</b></summary><pre did="object-json"></pre></details>
                </div>
            </li>
        </ul>
    </div>
    
    <div id="metrics" class="tab-pane fade">
        <h3>Metrics</h3>
        <p></p>
        	<div class="btn-group btn-group-toggle" >
    			<input type="radio" name="metrics-group" id="metrics-all" autocomplete="off" checked/>
    			<label for="metrics-all">All</label>
    			<input type="radio" name="metrics-group" id="metrics-a" autocomplete="off"/>
    			<label for="metrics-a">Group A</label>
    			<input type="radio" name="metrics-group" id="metrics-b" autocomplete="off"/>
    			<label for="metrics-b">Group B</label>
			</div>
		<p></p>
			<div class="btn-group">
				<input type="button" value="Refresh" id="refresh-metrics" />
				<input type="button" value="Reset Group A" id="reset-metrics-a" />
        		<input type="button" value="Reset Group B" id="reset-metrics-b" />
			</div>
		<p></p>
        <div id="metrics-list">
        </div>
    </div>

    <div id="errors" class="tab-pane fade">
        <h3>Log</h3>
        <ul class="list-group" id="errors-list"></ul>
        <ul class="list-group" id="errors-list-item" hidden="true">
            <li class="panel panel-default">
                <div class="panel-heading">
                    <p>Status: <b><span did="status"></span></b></p>
                </div>
                <div class="panel-body">
                    <p>Message: <b><span did="log-message"></span></b></p>
                    <p>Time: <b><span did="log-time"></span></b></p>
                    <p did="excep-message-hidden">Exception message: <b><span did="exception-message"></span></b></p>
                    <p did="block-hidden">Block (id, hash): <b><span did="block"></span></b></p>
                    <p did="operation-hidden">Operation: <b><span did="operation"></span></b></p>
                    <details did="block-json-hidden"><summary><b>Block json</b></summary><pre did="block-json"></pre></details>
                    <details did="op-json-hidden"><summary><b>Operation json</b></summary><pre did="operation-json"></pre></details>
                    <details did="full-json-hidden"><summary><b>Full Exception</b></summary><pre did="full-exception-json"></pre></details>
                </div>
            </li>
        </ul>

    </div>

    <div id="api" class="tab-pane fade">

        <!--BOT state-->
        <div class="row">
            <div class="col-md-12">
                <h4>Bots</h4><button class="btn btn-primary" id="refresh-bot-table-btn"><span class="glyphicon glyphicon-refresh"></span> Refresh</button>
                <br><br>
                <!--Bot table-->
                <div class="table-responsive">
                    <table id="bots-table" class="table table-bordered table-striped table-hover">
                        <thead>
                        <tr>
                            <th colspan="7">Bot Info</th>
                        </tr>
                        <tr>
                            <th>Id</th>
                            <th>Task name</th>
                            <th>Task description</th>
                            <th>Last launch</th>
                            <th>Interval</th>
                            <th>Progress</th>
                            <th>Actions</th>
                        </tr>
                        </thead>

                        <tbody>
                        </tbody>

                    </table>

                </div>

                <!--modal window for bot history-->
                <div class="modal fade" id="bot-history-modal" role="dialog">
                    <div class="modal-dialog modal-lg">

                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title" id="bot-history-header"></h4>
                                <p class="modal-title" id="history-bot-name"></p>
                            </div>
                            <div class="modal-body">
                                <h4>Bots</h4><button class="btn btn-primary" id="refresh-bot-history-btn"><span class="glyphicon glyphicon-refresh"></span> Refresh</button>
                                <div class="table-responsive">
                                    <table id="bots-history-table" class="table table-bordred table-striped table-hover">
                                        <thead>
                                        <tr>
                                            <th>Bot ID</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Total</th>
                                            <th>Processed</th>
                                            <th>Status</th>
                                        </tr>
                                        </thead>

                                        <tbody>
                                        </tbody>

                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h4>DB Index</h4>
                <button class="btn btn-primary" id="refresh-index-table-btn"><span class="glyphicon glyphicon-refresh"></span> Refresh</button>
                <button class="btn btn-primary"  data-toggle="modal" data-target="#new-index-modal" id="add-new-index-table-btn"><span class="glyphicon glyphicon-plus"></span> Add new DB Index</button>
                <br><br>
                <div class="table-responsive">
                    <table id="index-table" class="table table-bordered table-striped table-hover">
                        <thead>
                        <tr>
                            <th colspan="2">Index Info</th>
                            <th colspan="4">Column def</th>
                            <th colspan="1">Expression</th>
                            <th colspan="2">Additional info</th>
                        </tr>
                        <tr>
                            <th>Index</th>
                            <th>Op type</th>

                            <th>Table name</th>
                            <th>Column name</th>
                            <th>Column type</th>
                            <th>Index</th>

                            <th>Field expression</th>

                            <th>Cache Runtime Blocks</th>
                            <th>Cache DB Blocks</th>
                        </tr>
                        </thead>

                        <tbody>
                        </tbody>

                    </table>

                </div>
            </div>

            <!--modal window for bot history-->
            <div class="modal fade" id="new-index-modal" role="dialog">
                <div class="modal-dialog modal-lg">

                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title" id="new-bot-index-header">Adding new DB index</h4>
                        </div>
                        <div class="modal-body">
                            <h4>Bots</h4>
                            <label class="col-form-label">Input table name</label>
                            <input type="text" id="index-table-name" placeholder="table name" class="form-control">
                            <br>
                            <label class="col-form-label">Input column name</label>
                            <input type="text" id="index-col-name" placeholder="new column name" class="form-control">
                            <br>
                            <label class="col-form-label">Input column type</label>
                            <input type="text" id="index-col-type" placeholder="text, bigint[], ..." class="form-control">
                            <br>
                            <label class="col-form-label">Input op type</label>
                            <select class="form-control" multiple id="index-op-types"></select>
                            <br>
                            <label class="col-form-label">Input index type</label>
                            <select class="form-control" id="index-type">
                                <option selected value="true">true</option>
                                <option value="GIN">Gin</option>
                                <option value="GIST">Gist</option>
                            </select>
                            <br>
                            <label class="col-form-label">Input field</label>
                            <input type="text" id="index-field" placeholder="array -> source.osm.id, source.osm.tags" class="form-control">
                            <br>
                            <label class="col-form-label">Input sql mapping</label>
                            <input type="text" id="index-col-sql-mapping"  placeholder="array, single, ..." class="form-control">
                            <br>
                            <label class="col-form-label">Input cache runtime index</label>
                            <input type="text" id="index-cacheRuntimeMax" placeholder="64, 128, ..." class="form-control">
                            <br>
                            <label class="col-form-label">Input cache db index</label>
                            <input type="text" id="index-cacheDbIndex" placeholder="64, 128, ..." class="form-control">
                            <br>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" id="add-new-index-btn"><span class="glyphicon glyphicon-plus"></span> Add</button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h4>Downloads</h4> <button class="btn btn-primary" id="refresh-api-table-btn"><span class="glyphicon glyphicon-refresh"></span> Refresh</button>
                <br><br>
                <div class="table-responsive">
                    <table id="api-table" class="table table-bordered table-striped table-hover">
                        <thead>
                        <tr>
                            <th colspan="4">Report Info</th>
                            <th colspan="1"></th>
                        </tr>
                        <tr>
                            <th>File name</th>
                            <th>Path to file</th>
                            <th>Size</th>
                            <th>Last modified</th>

                            <th>Actions</th>
                        </tr>
                        </thead>

                        <tbody>
                        </tbody>

                    </table>

                </div>
            </div>
        </div>
    </div>

    <div id="settings" class="tab-pane fade">
        <h3>Settings</h3>
        <div class="col-12">
            <div class="col-1">
                <label class="col-form-label">Show editable settings</label>
                <input type="checkbox" id="settingsCheckbox" name="scales">
            </div>
        </div>
        <div style="display: none;" id="add-new-preference">
            <div class="col-md-12 container">
                <div class="col-md-4">
                    <label for="new-preference-key">Preference key:</label>
                    <input type="text" class="form-control" id="new-preference-key">
                </div>
                <div class="col-md-4">
                    <label for="new-preference-value">Preference value:</label>
                    <textarea class="form-control" rows="1" id="new-preference-value"></textarea>
                </div>
                <div class="col-md-2">
                    <label for="new-preference-type">Preference type:</label>
                    <select class="form-control" id="new-preference-type">
                        <option value="String" selected>String</option>
                        <option value="Long">Long</option>
                        <option value="Integer">Integer</option>
                        <option value="Float">Float</option>
                        <option value="Map">Map</option>
                        <option value="Boolean">Boolean</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="new-preference-restart">Restart is needed:</label>
                    <select class="form-control" id="new-preference-restart">
                        <option value="false" selected>false</option>
                        <option value="true">true</option>
                    </select>
                </div>
            </div>
            <br>
            <hr>
            <button class="btn btn-primary" id="add-new-preference-btn"></span> Add</button>
            <button class="btn btn-primary" id="cancel-new-preference-btn"></span> Cancel</button>
        </div>
        <hr>

        <div class="modal fade" id="settings-edit-modal" role="dialog">
            <div class="modal-dialog modal-lg">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title" id="settings-edit-header"></h4>
                        <p class="modal-title" id="settings-name"></p>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <h5 class="modal-title" id="settings-type-edit-header"></h5>
                            <p class="modal-title" id="settings-type" hidden="true"></p>
                        </div>
                        <hr>
                        <div class="container">
                            <div class="col-md-8">
                                <label for="edit-preference-value">Preference value:</label>
                                <textarea class="form-control" rows="1" id="edit-preference-value"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="save-new-value-for-settings-btn">Save</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>

            </div>
        </div>

        <div id="settings-result-list">
        </div>
    </div>

    <div id="ipfs" class="tab-pane fade">
        <h3>IPFS info</h3>
        <div>
            <p><b>IPFS status:</b> &nbsp;&nbsp;<span id="ipfs-status"></span></p>
            <p><b>Peer id:</b> &nbsp;&nbsp;<span id="ipfs-peer-id"></span></p>
            <p><b>Version:</b> &nbsp;&nbsp;<span id="ipfs-version"></span></p>
            <p><b>Gateway</b> &nbsp;&nbsp;<span id="ipfs-gateway"></span></p>
            <p><b>API</b> &nbsp;&nbsp;<span id="ipfs-api"></span></p>
            <p><b>Addresses</b> &nbsp;&nbsp;<span id="ipfs-addresses"></span></p>
            <p><b>Public key</b> &nbsp;&nbsp;<span id="ipfs-public-key"></span></p>
        </div>

        <h3>IPFS storage info</h3>
        <div>
            <p><b>Repo size:</b> &nbsp;&nbsp;<span id="ipfs-repo-size"></span></p>
            <p><b>Max storage:</b> &nbsp;&nbsp;<span id="ipfs-max-storage-size"></span></p>
            <p><b>Repo path</b> &nbsp;&nbsp;<span id="ipfs-repo-path"></span></p>
        </div>

        <h3>IPFS system info</h3>
        <div>
            <p><b>Disk info:</b> &nbsp;&nbsp;<span id="system-info"></span></p>
            <p><b>Memory:</b> &nbsp;&nbsp;<span id="system-memory"></span></p>
            <p><b>Runtime:</b> &nbsp;&nbsp;<span id="system-runtime"></span></p>
            <p><b>Network:</b> &nbsp;&nbsp;<span id="system-network"></span></p>
        </div>

        <h3>Stats</h3>
        <div>
            <p><b>All ipfs objects:</b> &nbsp;&nbsp;<span id="amount-all-ipfs-objects"></span></p>
            <p><b>Pinned ipfs objects:</b> &nbsp;&nbsp;<span id="amount-pinned-ipfs-objects"></span></p>
            <p><b>Missing ipfs objects:</b> &nbsp;&nbsp;<span id="amount-missing-ipfs-objects"></span></p>
            <p><b>DB objects:</b> &nbsp;&nbsp;<span id="amount-db-objects"></span></p>
            <p><b>Inactive objects:</b> &nbsp;&nbsp;<span id="amount-unactivated-objects"></span></p>
            <input type="submit" value="Load full stats" id="laod-full-stats-btn">
        </div>

        <h3>IPFS missing resources</h3>
        <div>
            <p><b>List of missing resources</b> &nbsp;&nbsp;<span id="ipfs-missing-objects"></span></p>
            <input type="submit" value="Upload missing resources to IPFS" id="fix-ipfs-missing-images-btn">
        </div>

        <h3>Inactive resources</h3>
        <div>
            <p><b>List of inactive resources: </b> &nbsp;&nbsp;<span id="blockchain-unactivated-images"></span></p>
            <input type="submit" value="Remove inactive resources" id="fix-blc-missing-images-btn">
        </div>

        <h3>Add Resource</h3>
        <div>
            1. File: <input type="file" id="image-file">
            <br>
            <input type="submit" value="Add File" id="add-file-btn">
            <br>
            <p><b>Result: </b> &nbsp;&nbsp;<span id="result-add-image"></span></p>
        </div>

        <h3>Get file</h3>
        <div>
            1. Cid of resource: <input type="text" id="get-image">
            <br>
            <a href="" id="image-link" download>
                <input type="submit" value="Get image" id="get-image-btn">
            </a>
            <br>
        </div>

    </div>


    <div id="reg" class="tab-pane fade">
        <h3>Signup</h3>
        <div>
            1. Nickname: <input type="text" id="signup-name"/>
            <br>
            2a. Password: <input type="password" id="signup-pwd"/>
            Old Password: <input type="password" id="signup-pwd-old"/>
            <br>
            2b. Private key: <input type="password" id="signup-user-prk"/>
            Public key: <input type="password" id="signup-user-pbk"/>
            <br>
            Old private key: <input type="password" id="signup-user-prk-old"/>
            Old public key: <input type="password" id="signup-user-pbk-old"/>
            <br>
            2c. OAuth provider: <input type="text" id="signup-oauth-p"/>
            OAuth Id: <input type="text" id="signup-oauth-id"/>
            <br>
            Old OAuth provider: <input type="text" id="signup-oauth-p-old"/>
            Old OAuth Id: <input type="text" id="signup-oauth-id-old"/>
            <br>
            3. User details (raw json): <input type="text" id="signup-details"/>
            <br>
            <input type="submit" value="Signup" id="signup-btn"/>
        </div>

        <h3>Login</h3>
        <div>
            1. Nickname + purpose (format 'nickname:site') : <input type="text" id="login-name"/>
            <br>
            2a. Signup Password: <input type="password" id="login-pwd"/>
            <br>
            2b. Signup or login private key: <input type="password" id="login-signup-key"/>
            <br>
            2c. Signup OAuth provider: <input type="text" id="login-oauth-p"/>
            Signup OAuth Id: <input type="text" id="login-oauth-id"/>
            <br>
            3. Public key (optional): <input type="text" id="login-public-key"/>
            <br>
            4. User details (raw json): <input type="text" id="login-details"/>
            <br>
            <input type="submit" value="Login" id="login-btn"/>
        </div>
        <h3>Sign message</h3>
        <div>
            1. Json: <input type="text" id="sign-json"/>
            <br>
            2. Name (empty will be server): <input type="text" id="sign-name"/>
            <br>
            3a. Password: <input type="text" id="sign-pwd"/>
            <br>
            3b. Signup private key: <input type="text" id="sign-pk"/>
            <br>
            4. Don't sign by server: <input type="checkbox" id="sign-by-server"/>
            <br>
            <input type="submit" value="Sign message" id="sign-btn"/>
            <input type="submit" value="Sign operation and add to queue" id="sign-add-btn"/>
        </div>
    </div>
</div>
</body>
<script>
    var loginName = "";
    var metricsData = [];
    
    function loadDataDelay(d=1500) {
        setTimeout(function() {
            loadData();
        }, d);
    }

    function loadData() {
        refreshUser();
        $.getJSON( "/api/auth/admin-status", function( data ) {
            loginName = data.admin;
            refreshUser();
            loadAllData();
        });
    }


    function loadAllData() {
        loadStatusData();
        loadObjectsData();
        loadBlocksData();
        if (loginName != "") {
            loadMetricsData();
            loadBotData();
            loadDBIndexData();
            loadReportFiles();
            loadConfiguration();
            loadErrorsData();
            loadIpfsStatusData();
        }
        if (window.location.search !== "") {
            checkUrlParam();
        }
    }

    function refreshUser() {
        if(loginName != "") {
            $("#admin-login-user").html(loginName);
            $("#admin-actions").show();
            $("#owner-actions").show();
            $("#admin-login-div").hide();
            $("#reg").show();
            $("#errors-tab").show();
            $("#metrics-tab").show();
            $("#api-tab").show();
            $("#settings-tab").show();
            $("#reg-tab").show();
            $("#ipfs-tab").show();
        } else {
            $("#admin-actions").hide();
            $("#owner-actions").hide();
            $("#admin-login-div").show();
            $("#errors-tab").hide();
            $("#reg-tab").hide();
            $("#api-tab").hide();
            $("#settings-tab").hide();
            $("#metrics-tab").hide();
            $("#reg").hide();
            $("#ipfs-tab").hide();
        }

    }
    
    
    function setMetricsDataToTable() {
    	var gid = 0;
    	if($("#metrics-a").prop("checked")) {
    		gid = 1;
    	}
    	if($("#metrics-b").prop("checked")) {
    		gid = 2;
    	}
    	var items = "";
        items += "<table border='1'>";
        items += "<tr>";
        items += "<th><b>Id</b><th>";
        items += "<th><b>Count</b><th>";
        items += "<th><b>Total (s)</b><th>";
        items += "<th><b>Average (ms)</b><th>";
        items += "<th><b>Throughput / sec</b><th>";
        items += "</tr>";
        
        for(var i = 0; i < metricsData.length; i++)  {
            let item = metricsData[i];
            items += "<tr>";
            var lid = item.id;
            if(lid.length > 50) {
                lid = lid.substring(0, 50);
            }
            items += "<td><b>"+lid+"</b><td>";
            items += "<td>"+item.count[gid]+"<td>";
            items += "<td>"+item.totalSec[gid]+"<td>";
            items += "<td>"+item.avgMs[gid]+"<td>";
            if(item.avgMs > 0) {
                items += "<td>"+Number(1000/item.avgMs[gid]).toFixed(2)+"<td>";
            } else {
                items += "<td>-<td>";
            } 
            items += "</tr>";
        }
        items += "</table>";
        $("#metrics-list").html(items);
    }
    
    function loadMetricsData() {
        $.getJSON( "/api/metrics", function( data ) {
        	metricsData = data.metrics;
        	setMetricsDataToTable();
        });
    }

    function loadErrorsData() {
        $.getJSON( "/api/logs", function( data ) {
            var items = "";
            var errs = 0;
            var templateItem = $("#errors-list-item");
            for(var i = 0; i < data.logs.length; i++)  {
                let op = data.logs[i];
                var it = templateItem.clone();

                it.find("[did='status']").html(op.status);
                it.find("[did='log-message']").html(op.message);
                it.find("[did='log-time']").html(new Date(op.utcTime).toUTCString());

                if(op.status) {
                    errs++;
                }
                if(op.cause) {
                    it.find("[did='exception-message']").html(op.cause.detailMessage);
                } else {
                    it.find("[did='excep-message-hidden']").prop("hidden", true);
                }
                if(op.block) {
                    it.find("[did='block']").html(op.block.block_id + " " + op.block.hash);
                } else {
                    it.find("[did='block-hidden']").prop("hidden", true);
                }
                if(op.operation) {
                    it.find("[did='operation']").html(op.operation.type + " " + op.operation.hash);
                } else {
                    it.find("[did='operation-hidden']").prop("hidden", true);
                }
                if(op.block) {
                    it.find("[did='block-json']").html(JSON.stringify(op.block, null, 4));
                } else {
                    it.find("[did='block-json-hidden']").prop("hidden", true);
                }
                if(op.operation) {
                    it.find("[did='operation-json']").html(JSON.stringify(op.operation, null, 4));
                } else {
                    it.find("[did='op-json-hidden']").prop("hidden", true);
                }
                if(op.cause) {
                    it.find("[did='full-exception-json']").html(JSON.stringify(op.cause, null, 4));
                } else {
                    it.find("[did='full-json-hidden']").prop("hidden", true);
                }
                items += it.html();
            }
            $("#errors-tab").html("Logs (" + errs + " Errors)");
            $("#errors-list").html(items);
        });
    }

    var globalObjectTypes = {};
    function loadObjectsData() {
        $("#index-list-id").hide();

        let selectType = $("#type-list").val();
        $.ajax({url:"/api/objects?type=sys.operation", type:"get", async:false,
            success: function(data) {
                var types = "<option value = '' selected disabled>Select type</option>";
                $("#objects-tab").html("Objects (" + data.objects.length + ")");
                for(var i = 0; i < data.objects.length; i++)  {
                    let obj = data.objects[i];
                    let objType = obj.id[0];
                    globalObjectTypes[objType] = obj;

                    types += "<option value = '"+objType+"' " +
                        (selectType === objType ? "selected" : "") + ">"+objType+"</option>";
                }
                $("#type-list").html(types);
                $("#index-op-types").html(types);
            },
            error: function(xhr, status, error) { $("#result").html("ERROR: " + error); }
        });
    }

    function loadStatusData() {
        $.getJSON( "/api/status", function( data ) {
            var items = "";
            $("#blockchain-status").html(data.status);
            items = "";
            for(var j = 0; j < data.sblocks.length; j++) {
            	var url = "admin?tab=operations&load=queue";
            	if(j > 0) {
            		var bldescr = data.sblocks[j];
            		if(bldescr.startsWith("DB-")) {
            			bldescr = bldescr.substring(3);
            		}
            		var ind = bldescr.indexOf("-");
            		var hash = bldescr.substring(ind + 1);
            		var limit = parseInt(bldescr.substring(0, ind), 16);
            		url = "admin?tab=blocks&search=to&hash="+hash+"&limit="+limit;
            	}
            	var name =  data.sblocks[j];
            	if(name.length > 12) {
            		name = name.substring(0, 12);
            	}
            	items += "<li><a href='"+url+"'>" + name + "</a>";
            	
            }
            $("#blockchain-blocks").html(items);
            $("#operations-tab").html("Operations (" + data.sblocks[0] + ")");

            $("#admin-user").html(data.serverUser);
            var ophS = Object.keys(data.orphanedBlocks);
            if(ophS.length > 0) {
                $("#blockchain-orphaned-blocks-header").show();
                $("#blockchain-orphaned-blocks").html(
                    JSON.stringify(ophS, null, 4) +
                    "<br><details><summary><b>Simple json</b></summary><pre>" +
                    JSON.stringify(data.orphanedBlocks, null, 4) + "</pre></details>");
            } else {
                $("#blockchain-orphaned-blocks-header").hide();
            }

        });
    }

    function loadIpfsStatusData() {
        $.getJSON("/api/ipfs/status?full=false", function ( data ) {
            $("#ipfs-status").html(data.status);
            $("#ipfs-peer-id").html(data.peerId);
            $("#ipfs-version").html(data.version);
            $("#ipfs-gateway").html(data.gateway);
            $("#ipfs-api").html(data.api);
            $("#ipfs-addresses").html(JSON.stringify(data.addresses));
            $("#ipfs-public-key").html(data.publicKey);

            // IPFS STORAGE
            $("#ipfs-repo-size").html(data.repoSize);
            $("#ipfs-max-storage-size").html(data.storageMax);
            $("#ipfs-repo-path").html(data.repoPath);

            // IPFS SYSTEM INFO
            $("#system-info").html(data.diskInfo);
            $("#system-memory").html(data.memory);
            $("#system-runtime").html(data.runtime);
            $("#system-network").html(data.network);

            // IPFS STATS
            $("#amount-all-ipfs-objects").html(data.amountIpfsResources);
            $("#amount-pinned-ipfs-objects").html(data.amountPinnedIpfsResources);
        });
    }

    function processBlocksResult(data) {
        var items = "";
        var blocks = data.blocks;
        // SHOW currentBlock, currentTx - as in progress or failed
        $("#blocks-tab").html("Blocks (" + data.blockDepth + ")");
        var superblockId = 0;
        var superblockHash = "";
        let templateItem = $("#blocks-list-item");
        for(var i = 0; i < blocks.length; i++) {
            let op = blocks[i];
            var it = templateItem.clone();
            var onlyhash = op.hash.split(":");
            it.find("[did='block-operation-link']").attr("href", "/api/admin?tab=operations&loadBy=blockHash&key=" + onlyhash[onlyhash.length -1]);
            it.find("[did='block-id']").html(op.block_id);
            it.find("[did='signed-by']").html(op.signed_by);
            it.find("[did='block-hash']").html(op.hash);
            it.find("[did='op-count']").html(op.eval.operations_size);
            it.find("[did='block-date']").html(op.date.replace("T", " ").replace("+0000", " UTC"));

            if (op.eval) {
                if (op.eval.superblock_hash != superblockHash) {
                    superblockHash = op.eval.superblock_hash;
                    superblockId = superblockId + 1;
                }

                it.find("[did='superblock']").html(superblockId + ". " + op.eval.superblock_hash);
                it.find("[did='block-size']").html((op.eval.block_size/1024).toFixed(3) + " KB");
                it.find("[did='block-objects']").html(op.eval.obj_added + "/" + op.eval.obj_edited + "/" + op.eval.obj_deleted);
                it.find("[did='block-objects-info']").html("<b>" +
                		op.eval.operations_size + "</b> operations ( <b>" +
                		op.eval.obj_added + "</b> added, <b>" + op.eval.obj_edited + "</b> edited, <b>" + op.eval.obj_deleted + "</b> removed objects )");
            }

            it.find("[did='prev-block-hash']").html(op.previous_block_hash);
            it.find("[did='merkle-tree']").html(op.merkle_tree_hash);
            it.find("[did='block-details']").html(op.details);

            it.find("[did='block-json']").html(JSON.stringify(op, null, 4));
          
          items += it.html(); 
          
        }

        return items;
    }

    function loadBlocksData() {
        $.getJSON( "/api/blocks", function( data ) {
            var items = processBlocksResult(data);
            $("#blocks-list").html(items);
        });
    }

    function laadBlockAmount() {
        $.getJSON( "/api/blocks", function( data ) {
            $("#blocks-tab").html("Blocks (" + data.blockDepth + ")");
        });
    }

    function loadFullIpfsStatus() {
        $(document).ready(function () {
            $.getJSON("/api/ipfs/status?full=true", function (data) {
                $("#result").html("SUCCESS: " + data);
                $("#amount-missing-ipfs-objects").html(data.missingResources.length);
                $("#amount-db-objects").html(data.amountDBResources);
                $("#amount-unactivated-objects").html(data.deprecatedResources.length);

                console.log("tsts");
                for(var i = 0; i < data.missingResources.length; i++)  {
                    $("#ipfs-missing-objects").html(data.missingResources[i].hash + " , ");
                };
                for(var i = 0; i < data.deprecatedResources.length; i++)  {
                    $("#blockchain-unactivated-images").append(data.deprecatedResources[i].hash + " , ");
                };
            });
        });
    }

    function editPreferenceObject(i) {
        console.log(globalConfig[i]);
        if (globalConfig[i].type === "Map") {
            $("#settings-edit-modal .modal-body #edit-preference-value").val(JSON.stringify(globalConfig[i].value, null, 4));
        } else {
            $("#settings-edit-modal .modal-body #edit-preference-value").val(globalConfig[i].value);

        }
        $("#settings-edit-modal .modal-body #settings-type-edit-header").html("Preference type: " + globalConfig[i].type);
        $("#settings-edit-modal .modal-body #settings-type").html(globalConfig[i].type);
        $("#settings-edit-modal .modal-body #edit-preference-restart").val(globalConfig[i].restartIsNeeded.toString());
        $("#settings-edit-modal .modal-header #settings-name").val(globalConfig[i].id);
        $("#settings-edit-modal .modal-header #settings-edit-header").html("Preference: " + globalConfig[i].id);
    }

    var globalConfig = {};
    function loadConfiguration() {
        $.getJSON("/api/mgmt/config", function (data) {
            // var items = "";
            var items = "";
            globalConfig = data;

            function showSettings() {
                items += "<div class=\"panel panel-default col-7\">";
                items += "<div class=\"panel-heading\">";
                if (obj.canEdit === true) {
                    items += "<button type=\"button\" class=\"btn btn-default btn-sm pull-right\" data-toggle=\"modal\" data-target=\"#settings-edit-modal\" onclick=\"editPreferenceObject(" + i + ")\">Edit</button></a>";
                }
                items += "<h4>" + obj.id + " - " + obj.description + "</h4></div><div class=\"panel-body\">";

                if (obj.type === "Map") {
                    items += "<h5><b>Value: </b></h5>";
                    items += "<pre>" + JSON.stringify(obj.value, null, 4) + "</pre>"
                } else {
                    items += "<h5><b>Value: </b>" + obj.value + "</h5>";
                }
                items += "<div class=\"row\">";
                if (obj.restartIsNeeded === true) {
                    items += "<div class=\"alert alert-warning\" role=\"alert\">This parameter will be accepted after server restarting!</div>";
                }
                items += "</div>";
                items += "</div>";
                items += "</div>";
            }

            for (var i = 0; i < data.length; i++) {
                obj = data[i];
                if ($("#settingsCheckbox").is(":checked") && obj.canEdit === true) {
                    showSettings();
                } else if (!($("#settingsCheckbox").is(":checked"))) {
                    showSettings();
                }

            }

            $("#settings-result-list").html(items);
        });
    }

    function loadBotData() {
        $.getJSON("/api/bot/stats", function (data) {
            var items = "";
            for (var key in data) {
                var obj = data[key];
                items += "<tr>";
                items += "<td>" + obj.id + "</td>";
                if ('botStats' in obj) {
                items += "<td>" + obj.botStats.taskName + "</td>";
                items += "<td>" + obj.botStats.taskDescription + "</td>";
                } else {
                    items += "<td></td>";
                    items += "<td></td>";
                }
                items += "<td>" + new Date(obj.started).toLocaleString() + "</td>";
                items += "<td>" + obj.interval + "</td>";
                if ('botStats' in obj) {
                    if (!obj.botStats.isRunning) {
                        items += "<td>NOT RUNNING</td>"
                    } else {
                        var progressBarValue = parseInt((obj.botStats.progress / obj.botStats.total) * 100);
                        items += "<td><div class=\"progress\">\n" +
                            "  <div class=\"progress-bar progress-bar-info progress-bar-striped\" role=\"progressbar\"\n" +
                            "  aria-valuenow=\"" + progressBarValue + "\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width:" + progressBarValue + "%\">\n" +
                            progressBarValue + "%" +
                            "  </div>\n" +
                            "</div></td>";
                    }
                } else {
                    items += "<td></td>";
                }
                items += "<td>";
                if ('botStats' in obj && obj.botStats.isRunning === false) {
                    items += "<button type=\"button\" class=\"btn btn-primary\" style=\"margin-left:5px;\" onclick=\"startBot('" + obj.id + "')\"><span class=\"glyphicon glyphicon-play\"></span></button>";
                } else {
                    items += "<button type=\"button\" class=\"btn btn-primary\" style=\"margin-left:5px;\" onclick=\"stopBot('" + obj.id + "')\"><span class=\"glyphicon glyphicon-pause\"></span></button>";
                }
                items += "<button type=\"button\" class=\"btn btn-primary\" data-toggle=\"modal\" data-target=\"#bot-history-modal\" style=\"margin-left:5px;\" onclick=\"showBotHistory('" + obj.id + "')\"><span class=\"glyphicon glyphicon-eye-open\"></span></button>";
                items += "</td>";
                items += "</tr>";

            }

            $("#bots-table > tbody").html(items);
        });
    }

    function loadReportFiles() {
        $.getJSON("/api/places/report", function (data) {
            var items = "";
            for (var i = 0; i < data.length; i++) {
                var obj = data[i];
                items += "<tr>";
                items += "<td>" + obj.fileName + "</td>";
                items += "<td>" + obj.filePath + "</td>";
                items += "<td>" + (obj.size/1024/1024).toFixed(3) + " MB" + "</td>";
                items += "<td>" + new Date(obj.date).toLocaleString() + "</td>";
                items += "<td>";
                    items += "<a href=\"/api/places/report/" + obj.fileName + "\" download=\"" + obj.fileName + "\">\n" +
                        "  <span class=\"glyphicon glyphicon-download\"></span>" +
                        "</a>";
                    items += "<button type=\"button\" class=\"btn btn-link\" style=\"margin-left:5px;\" onclick=\"updateReport('" + obj.fileName + "')\"><span class=\"glyphicon glyphicon-refresh\"></span></button>";
                items += "</td>";
                items += "</tr>";
            }

            $("#api-table > tbody").html(items);
        })
    }

    function loadDBIndexData() {
        $.getJSON("/api/index", function (data) {
            var items = "";
            for (var key in data) {
                var obj = data[key];
                items += "<tr><td class='info' colspan='9'>" + key + "</td></tr>";
                for (var keyObj in obj) {
                    var index = obj[keyObj];
                    items += "<tr>";
                    items += "<td>" + index.indexId + "</td>";
                    items += "<td>" + index.opType + "</td>";
                    items += "<td>" + index.columnDef.tableName + "</td>";
                    items += "<td>" + index.columnDef.colName + "</td>";
                    items += "<td>" + index.columnDef.colType + "</td>";
                    items += "<td>" + index.columnDef.index + "</td>";
                    if (index.fieldsExpression.length >= 1) {
                        items += "<td>" + index.fieldsExpression[0].expression + "</td>";
                    } else {
                        items += "<td></td>";
                    }
                    items += "<td>" + index.cacheRuntimeBlocks + "</td>";
                    items += "<td>" + index.cacheRuntimeBlocks + "</td>";
                    items += "</tr>";
                }
            }
            $("#index-table > tbody").html(items);
        })
    }

    function generateOperationResponse(data) {
        var items = "";
        let templateItem = $("#operation-list-item");
        if (JSON.stringify(data) !== '{}') {
            for (var i = 0; i < data.ops.length; i++) {
                var it = templateItem.clone();
                let op = data.ops[i];
                let clone = JSON.parse(JSON.stringify(op));
                delete clone.hash;
                delete clone.signature;
                delete clone.signature_hash;
                delete clone.validation;
                delete clone.eval;
                if (clone.create) {
                    for (var ik = 0; ik < clone.create.length; ik++) {
                        if (clone.create[ik].changesForObject) {
                            for (var il = 0; il < clone.create[ik].changesForObject.length; il++) {
                                delete clone.create[ik].changesForObject[il].eval;
                            }
                        }
                        delete clone.create[ik].eval;
                    }
                }
                if (clone.edit) {
                    for (var j = 0; j < clone.edit.length; j++) {
                        delete clone.edit[j].eval;
                    }
                }

                if (clone.delete) {
                    for (var j = 0; j < clone.delete.length; j++) {
                        delete clone.delete[j].eval;
                    }
                }

                sha256(JSON.stringify(clone)).then(digestValue => {
                    if(("json:sha256:" + digestValue) != op.hash){
                    alert("Warning! Hash of tx '" + op.hash + "' is not correct - 'json:sha256:" + digestValue + "'");
                }});


                var create = "";
                if (Array.isArray(op.create)) {
                    if (op.create.length > 1) {
                        create = op.create.length;
                    } else {
                        create = op.create.length + " [" + op.create[0].id + "]";
                    }
                } else {
                    if (op.create) {
                        create = "1 [" + op.create.id + "]";
                    }
                }
                var edited = "";
                if (Array.isArray(op.edit)) {
                    if (op.edit.length > 1) {
                        edited = op.edit.length;
                    } else {
                        edited = op.edit.length + " [" + op.edit[0].id + "]";
                    }
                } else {
                    if (op.edit) {
                        edited = "1 [" + op.edit.id + "]";
                    }
                }
                var deleted = "";
                if (Array.isArray(op.delete)) {
                    if (op.delete.length > 1) {
                        deleted = op.delete.length;
                    } else {
                        deleted = op.delete.length + " [" + op.delete[0] + "]";
                    }
                } else {
                    if (op.delete) {
                        deleted = "1 [" + op.delete + "]";
                    }
                }

                var objectInfo = "";
                if (create !== "") {
                    objectInfo +=   "<b>" + create + "</b> added "
                }
                if (edited !== "") {
                    objectInfo +="<b>" + edited + "</b> edited "
                }
                if (deleted !== "") {
                    objectInfo +=  "<b>" + deleted + "</b> removed ";
                }

                it.find("[did='operation-object-link']").attr("href", "/api/admin?tab=objects&search=null&type=opHash&key=" + op.hash + "&history=true&limit=50");
                it.find("[did='op-hash']").html(op.hash);
                it.find("[did='op-type']").html(op.type);
                it.find("[did='object-info']").html(objectInfo);
                it.find("[did='signed-by']").html(op.signed_by);
                it.find("[did='op-json']").html(JSON.stringify(op, null, 4));
                items += it.html();
            }
            $("#amount-operations").html("Amount operations: " + data.ops.length);
        } else {
            $("#amount-operations").html("Amount operations: " + 0);
        }
        $("#operations-list").html(items);
    }

    var editor = {};
    var originObject;
    var globalObjects = {};
    function generateJsonFromObject(obj) {
        $("#json-display").show();

        var target = $("#json-display");
        if( target.length ) {
            event.preventDefault();
            $('html, body').stop().animate({
                scrollTop: target.offset().top
            }, 1000);
        }
        $("#editing-objects").show();
        $("#stop-edit-objects").show();
        delete obj.eval;
        originObject = obj;
        editor = new JsonEditor('#json-display', obj);
        editor.load(obj);
    }

    function showOperationsByBlockRowHash(blockHash) {
        blockHash = blockHash.split(':')[1];
        saveCurrentState("#blocks", '/api/admin?tab=blocks&type=' + $("#blocks-search").val() + '&showOpByHash=' + blockHash);
        $(".nav-tabs a[href=\"#operations\"]").tab('show');
        $("#operations-search").val("blockHash").change();
        $("#operations-key").val(blockHash);

        // TODO change this
        setTimeout(function(){
            $("#operations-search-btn").click();
        }, 200);
    }

    function getHistoryObjects(obj) {
        var items = "";
        items += "<br><li class=\"list-group-item\"><b>Id</b>: " + obj.id;
        items += "<br><b>Date</b>: " + obj.date;
        if (obj.objEdit.eval !== undefined) {
            items += "<br><b>Type</b>: " + obj.objType;
            items += "<br><b>Op hash</b>: " + obj.opHash;
        }
        if (obj.objEdit.comment !== undefined) {
            items += "<br><b>Comment</b>: " + obj.objEdit.comment;
        }
        if (obj.userId.length !== 0) {
            items += "<br><b>User</b>: " + obj.userId;
        }
        items += "<br><b>Status</b>: " + obj.status;
        if ('objEdit' in obj) {
            delete obj.objEdit.eval;
            items += "<details><summary><b>Obj json: </b></summary><pre>" +
                JSON.stringify(obj.objEdit, null, 4) + "</pre></details>";
        }
        if ('deltaChanges' in obj) {
            items += "<details><summary><b>Delta json: </b></summary><pre>" +
                JSON.stringify(obj.deltaChanges, null, 4) + "</pre></details>";
        }
        items += "</li>";
        return items;
    }

    function getHistoryForObject(searchType, key) {
        var obj = {
            "type": searchType,
            "key": key,
            "limit": $("#limit-field").val(),
            "sort": "DESC"
        };
        var items = "";
        var amount = 0;
        $.ajax({url:"/api/history", type:"get", async:false, data:obj,
            success: function(data) {
                for (var i = 0; i < data.length; i++) {
                    var object = data[i];
                    items += getHistoryObjects(object);
                }
                amount = data.length;
            },
            error: function(xhr, status, error) { $("#result").html("ERROR: " + error); }});

        return {
          items: items,
          amount: amount
        };
    }

    function loadHistoryForObject(searchType,id, type) {
        $("#search-type-list").val("id");
        $("#historyCheckbox").prop('checked', true);
        $("#search-key-input").show();
        $("#name-key-field").text("Input Object ID")
        $("#search-key").val(id);

        var _res = getHistoryForObject("object", type + "," + id);

        $("#objects-list").html(_res.items);
        $("#amount-objects").html("Count results: " + _res.amount);
        saveCurrentState("#objects", "/api/admin?tab=objects&search=" + searchType + "&type=" + type + "&key=" + id + "&history=true");
    }

    function loadHistoryByOperationHash(key) {
        $(".nav-tabs a[href=\"#objects\"]").tab('show');

        $("#search-type-list").val("opHash");
        $("#historyCheckbox").prop('checked', true).prop("disabled", true);
        $("#search-key-input").show();
        $("#name-key-field").text("Input Op Hash")
        $("#search-key").val(key);

        var _res = getHistoryForObject("operation", key);

        $("#objects-list").html(_res.items);
        $("#amount-objects").html("Count results: " + _res.amount);
        saveCurrentState("#objects", "/api/admin?tab=objects&search=none" + "&type=opHash" + "&key=" + key + "&history=true");
    }

    function saveCurrentState(tab, url) {
        if (window.location.pathname + window.location.search !== url && url !== window.location.pathname && url !== (window.location.pathname + "?")) {
            if (tab === "#objects") {
                saveObjectTabState(tab, url);
            } else if (tab === "#operations") {
                saveOperationTabState(tab, url);
            } else if (tab === "#blocks") {
                saveBlocksTabState(tab, url);
            }
        }
    }

    function saveBlocksTabState(tab, url) {
        var idStorage = '_' +  Math.random().toString(36).substr(2, 9);
        var res = {
            tab: tab,
            blockSearch: $("#blocks-search").val(),
            showInput: $("#block-from-fields").is(":hidden"),
            inputKey: $("#search-block-field").val(),
            inputLimit: $("#block-limit-value").val(),
            idStorage: idStorage
        };

        sessionStorage.setItem(idStorage,  document.getElementById("blocks-list").innerHTML);
        window.history.pushState(res, "State Blocks", url);
    }

    function saveOperationTabState(tab, url) {
        var idStorage = '_' +  Math.random().toString(36).substr(2, 9);
        var res = {
            tab: tab,
            inputSearch:$("#input-search-operation-key").text(),
            keyHidden:$("#operations-search-fields").is(":hidden"),
            keyValue: $("#operations-key").val(),
            load: $("#operations-search").val(),
            countElements: $("#amount-operations").text(),
            idStorage: idStorage
        };

        sessionStorage.setItem(idStorage, document.getElementById("operations-list").innerHTML);
        window.history.pushState(res, "State Operations", url);
    }

    function saveObjectTabState(tab, url) {
        var idStorage = '_' + Math.random().toString(36).substr(2, 9);
        var res = {
            tab: tab,
            searchType: $("#search-type-list").val(),
            type: $("#type-list").val(),
            showHistory: $("#historyCheckbox").is(":checked"),
            historyDisabled: $("#historyCheckbox").is(":disabled"),
            key: $("#search-key").val(),
            limit: $("#limit-field").val(),
            countElements: $("#amount-objects").text(),
            idStorage: idStorage
        };

        sessionStorage.setItem(idStorage, document.getElementById("objects-list").innerHTML);
        console.log(res);
        window.history.pushState(res, "State Objects", url);
        console.log(window.history);
    }

    function showOperations(data, url) {
        generateOperationResponse(data);
        saveCurrentState("#operations", url);
    }

    function checkUrlParam() {
        // objects -> http://localhost:6463/api/admin?tab=objects&search=osm.place&type=id&key=12345662&history=true
        // operations -> http://localhost:6463/api/admin?tab=operations&loadBy=blockId&key=0
        // blocks -> http://localhost:6463/api/admin?tab=blocks&search=from&hash=213&limit=123
        var url = new URL(window.location.href);
        if (window.location.href.toLowerCase().indexOf('api/admin?tab=objects') > 1) {
            $(".nav-tabs a[href=\"#objects\"]").tab('show');
            setTimeout(function(){
                var searchTypeListValue = url.searchParams.get('search');
                if (searchTypeListValue !== null) {
                    setTimeout(function() {
                        $("#type-list").val(searchTypeListValue);
                        $("#type-list").change();
                    }, 200);
                }
                var typeSearch = url.searchParams.get('type');
                if (typeSearch !== null) {
                    setTimeout(function() {
                        $("#search-type-list").val(typeSearch).change();
                    }, 200);
                }
                var checkboxValue = url.searchParams.get('history');
                if (checkboxValue !== null) {
                    $("#historyCheckbox").prop('checked', checkboxValue === "true");
                } else {
                    $("#search-type-list").change();
                }
                var limitValue = url.searchParams.get('limit');
                if (limitValue !== null) {
                    $("#limit-field").val(limitValue);
                }
                var keyValue = url.searchParams.get('key');
                if (keyValue !== null) {
                    $("#search-key").val(keyValue);
                }

                setTimeout(function() {
                    $("#load-objects-btn").click();
                }, 200);
            }, 300);
        } else if (window.location.href.toLowerCase().indexOf('api/admin?tab=operations') > 1) {
            $(".nav-tabs a[href=\"#operations\"]").tab('show');
            var loadType = url.searchParams.get('loadBy');
            if (loadType !== null) {
                setTimeout(function() {
                    $("#operations-search").val(loadType).change();
                }, 200);
            }
            var key = url.searchParams.get('key');
            if (key !== null) {
                $("#operations-key").val(key);
            }

            setTimeout(function(){
                $("#operations-search-btn").click();
            }, 200);
        } else if (window.location.href.toLowerCase().indexOf('api/admin?tab=blocks') > 1) {
            $(".nav-tabs a[href=\"#blocks\"]").tab('show');
            var searchType = url.searchParams.get('search');
            if (searchType !== null) {
                setTimeout(function() {
                    $("#blocks-search").val(searchType).change();
                }, 200);
            }
            var hashValue = url.searchParams.get('hash');
            if (hashValue !== null) {
                $("#search-block-field").val(hashValue);
            }
            var limit = url.searchParams.get('limit');
            if (limit !== null) {
                $("#block-limit-value").val(limit);
            }

            setTimeout(function() {
                $("#block-load-btn").click();
            }, 200);
        }
    }

    function startBot(bot) {
        var obj = {
            "botName":bot
        };
        $.get("/api/bot/start", obj)
            .done(function (data) {$("#result").html(data)})
            .fail(function(xhr, status, error) { $("#result").html("ERROR: " + error); });
    }

    function stopBot(bot) {
        var obj = {
            "botName":bot
        };
        $.get("/api/bot/stop", obj)
            .done(function (data) {$("#result").html(data)})
            .fail(function(xhr, status, error) { $("#result").html("ERROR: " + error); });
    }

    function showBotHistory(bot) {
        var obj = {
            "botName" : bot
        };
        //[{"bot":"opr-type","status":"SUCCESS","startDate":"Sep 5, 2019, 11:50:45 AM","endDate":"Sep 5, 2019, 11:51:40 AM","total":25858,"processed":25858}]
        $.getJSON("/api/bot/history", obj)
            .done(function (data) {
                var items = "";
                for (var i=0; i < data.length; i++) {
                    var obj = data[i];
                    items += "<tr>";
                    items += "<td>" + obj.bot + "</td>";
                    items += "<td>" + new Date(obj.startDate).toLocaleString() + "</td>";
                    if (obj.endDate !== undefined) {
                        items += "<td>" + new Date(obj.endDate).toLocaleString() + "</td>";
                    } else {
                        items += "<td></td>"
                    }
                    items += "<td>" + obj.total + "</td>";
                    items += "<td>" + obj.processed + "</td>";
                    items += "<td>" + obj.status + "</td>";
                    items += "</tr>";
                }
                $(".modal-body #bots-history-table  > tbody").html(items);
                $(".modal-header #history-bot-name").val(bot);
                $(".modal-header #bot-history-header").html("History of the launches for bot: " + bot);
            })
            .fail(function(xhr, status, error) { $("#result").html("ERROR: " + error); });
    }

    function updateReport(file) {
        $.ajax({url:"/api/places/report/" + file, type:"PUT", async:false,
            success: function (data) {
                $("#result").html(data);
                $("#refresh-api-table-btn").click();
            },
            error:function(xhr, status, error) { $("#result").html("ERROR: " + error); }
        });
    }

    function closeBotHistory() {
        $("#bots-history-table").hide();
    }

    setInterval(function(){
        $("#refresh-bot-table-btn").click();
        loadStatusData();
        laadBlockAmount();
        loadBotData();
    }, 15000);

    $( document ).ready(function() {
        loadData();
        $("#clear-list-btn").click(function(){
            $.post("/api/mgmt/queue-clear", {},  function(data, status){
                loadData();
            });
        });

        $("#clear-log-btn").click(function(){
            $.post("/api/mgmt/logs-clear", {},  function(data, status){
                loadData();
            });
        });

        $("#compact-btn").click(function(){
            $.post("/api/mgmt/compact", {},  function(data, status){
                loadDataDelay();
            });
        });
        $("#replicate-btn").click(function(){
            $.post("/api/mgmt/replicate", {},  function(data, status){
                loadDataDelay();
            });
        });

        $("#config-list").change(function () {
            var selected = $("#config-list").val();
            if (globalConfig[selected].toString() === "[object Object]") {
                $("#config-value").val(JSON.stringify(globalConfig[selected], null, 4)).attr("rows", 20);
            } else {
                $("#config-value").val(globalConfig[selected]).attr("rows", 1);
            }
        });

        $("#settingsCheckbox").change(function () {
           loadConfiguration();
        });

        $("#search-type-list").change(function() {
            var selectedSearchType = $("#search-type-list").val();
            if (selectedSearchType === "all") {
                if ($("#type-list").val() === "none") {
                    $("#historyCheckbox").prop('checked', true)
                } else {
                    $("#search-key-input").hide();
                    $("#historyCheckbox").prop("disabled", false);
                }
            } else if ( selectedSearchType === "count") {
                $("#search-key-input").hide();
                $("#historyCheckbox").prop("disabled", true).prop('checked', false);
            } else if (selectedSearchType === "userId") {
                $("#search-key-input").show();
                $("#name-key-field").text("Input User ID");
                $("#historyCheckbox").prop('checked', true).prop("disabled", true);
            } else if (selectedSearchType === "opHash") {
                $("#search-key-input").show();
                $("#type-list").val("none");
                $("#name-key-field").text("Input Op Hash");
                $("#historyCheckbox").prop('checked', true).prop("disabled", true);
            } else {
                $("#search-key-input").show();
                if (selectedSearchType === "id") {
                    $("#name-key-field").text("Input Object ID");
                } else {
                    $("#name-key-field").text("Input " + $("#search-type-list").val());
                }
                $("#historyCheckbox").prop("disabled", false);
            }
        });

        function loadSearchTypeByOpType(type) {
            $.ajax({url:"/api/indices-by-type?type=" + type, type:"get", async:false,
                success: function(data) {
                    var searchTypes = "";
                    searchTypes += "<option value = 'all' selected>all</option>";
                    searchTypes += "<option value = 'id' >by id</option>";
                    searchTypes += "<option value = 'count' >count</option>";
                    searchTypes += "<option value = 'userId' >by userId</option>";
                    searchTypes += "<option value = 'opHash' >by opHash</option>";
                    for (var i = 0; i < data.length; i++) {
                        var obj = data[i];
                        searchTypes += "<option value = " + obj.indexId + ">by " + obj.indexId + "</option>";
                    }

                    $("#search-type-list").html(searchTypes);
                    $("#historyCheckbox").prop("disabled", false);
                    $("#search-key-input").hide();
                },
                error: function(xhr, status, error) { $("#result").html("ERROR: " + error); }
            });

        }

        $("#type-list").change(function () {
            var type = $("#type-list").val();
            loadSearchTypeByOpType(type);
        });

        $("#operations-search").change(function () {
           var type = $("#operations-search").val();
           if (type === "queue") {
               $("#operations-search-fields").hide();
               // $("#operations-key").hide();
               // $("#input-search-operation-key").hide();

           } else {
               $("#operations-search-fields").show();
               // $("#operations-key").show();
               // $("#input-search-operation-key").show();
               if (type === "id") {
                   $("#input-search-operation-key").text("Input object id");
               } else if (type === "blockId") {
                   $("#input-search-operation-key").text("Input block Id");
               } else {
                   $("#input-search-operation-key").text("Input block hash");
               }
           }
        });

        $("#refresh-index-table-btn").click(function () {
           loadDBIndexData();
        });

        $("#add-new-index-btn").click(function () {
            var myJSObject = {
                tableName:$("#index-table-name").val(),
                colName:$("#index-col-name").val(),
                colType:$("#index-col-type").val(),
                types:$("#index-op-types").val(),
                index:$("#index-type").val(),
                sqlMapping:$("#index-col-sql-mapping").val(),
                cacheRuntimeMax:$("#index-cacheRuntimeMax").val(),
                cacheDbIndex:$("#index-cacheDbIndex").val(),
                field:($("#index-field").val()).split(",")
            };
            $.ajax("/api/mgmt/index", {
                data: JSON.stringify(myJSObject),
                contentType: 'application/json',
                type: 'POST',
                success: function(data) {

                },
                error: function(xhr, status, error) {

                }
            });
            $("#new-index-modal .close").click();
        });

        $("#refresh-api-table-btn").click(function () {
            loadReportFiles();
        });

        $("#refresh-bot-table-btn").click(function () {
            loadBotData();
        });

        $("#blocks-search").change(function () {
           var type = $("#blocks-search").val();
           if (type === "all") {
               $("#block-from-fields").hide();
           } else {
               $("#block-from-fields").show();
           }
        });
        
        $("#metrics-all").click(function() {
        	setMetricsDataToTable();
        });
        $("#metrics-a").click(function() {
        	setMetricsDataToTable();
        });
        $("#metrics-b").click(function() {
        	setMetricsDataToTable();
        });
        $("#reset-metrics-b").click(function(){
        	$.post("/api/metrics-reset?cnt=2", {})
            .done(function(data){  metricsData = data.metrics; $("#metrics-b").prop("checked", true); setMetricsDataToTable(); })
            .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });
        
        $("#refresh-metrics").click(function(){
        	$.get("/api/metrics", {})
            .done(function(data){  metricsData = data.metrics; setMetricsDataToTable(); })
            .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });

        $("#reset-metrics-a").click(function(){
        	$.post("/api/metrics-reset?cnt=1", {})
            .done(function(data){  metricsData = data.metrics; $("#metrics-a").prop("checked", true); setMetricsDataToTable(); })
            .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });
        

        $("#block-create-btn").click(function(){
            $.post("/api/mgmt/create", {})
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });

        $("#block-revert-btn").click(function(){
            $.post("/api/mgmt/revert-superblock", {})
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });
        $("#block-1revert-btn").click(function(){
            $.post("/api/mgmt/revert-1-block", {})
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });
        $("#ops-pause-btn").click(function(){
            $.post("/api/mgmt/toggle-blockchain-pause", {})
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });
        $("#blocks-pause-btn").click(function(){
            $.post("/api/mgmt/toggle-blocks-pause", {})
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });
        $("#replicate-pause-btn").click(function(){
            $.post("/api/mgmt/toggle-replicate-pause", {})
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });

        $("#remove-orphaned-blocks-btn").click(function(){
            $.post("/api/mgmt/delete-orphaned-blocks", {
                "blockListOrSingleValue" : $("#remove-orphaned-blocks-txt").val()
            })
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });

        $("#remove-queue-ops-btn").click(function(){
            $.post("/api/mgmt/delete-queue-ops", {
                "opsListOrSingleValue" : $("#remove-queue-ops-txt").val()
            })
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });


        $("#block-bootstrap-btn").click(function(){
            $.post("/api/mgmt/bootstrap", {})
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });

        $("#admin-login-btn").click(function() {
            var obj = {
                "pwd":$("#admin-login-key").val(),
                "name":$("#admin-login-name").val()
            };
            $.post("/api/auth/admin-login", obj)
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error);  });
        });

        $("#load-objects-btn").click(function () {
            var searchType = $("#search-type-list").val();
            var type = $("#type-list").val();
            var key = $("#search-key").val();
            $("#json-display").hide();
            $("#editing-objects").hide();
            $("#stop-edit-objects").hide();
            $("#add-edited-obj").hide();

            if (searchType === "count") {
                $.getJSON("/api/objects-count?type=" + type, function (data) {
                    var items = "";
                    globalObjects = [];
                    $("#objects-list").html(items);
                    $("#amount-objects").html("Count results: " + data.count);
                    saveCurrentState('#objects', '/api/admin?tab=objects&search=' + type + '&type=' + searchType + '&history=' + $("#historyCheckbox").is(":checked"));
                });
            } else {
                let funcProcResults = function (data, url) {
                    var items = "";
                    let templateItem = $("#objects-list-item");
                    var amountResults = 0;
                    globalObjects = data.objects;
                    for (var i = 0; i < data.objects.length; i++) {
                        let obj = data.objects[i];
                        if ($("#historyCheckbox").is(":checked") === true) {
                            let _res = getHistoryForObject("object", type + "," + obj.id);
                            items += _res.items;
                            amountResults += _res.amount;
                        } else {
                            var it = templateItem.clone();
                            it.find("[did='op-hash']").html(obj.eval.parentHash);
                            it.find("[did='obj-id']").html(obj.id.toString());
                            if (obj.comment) {
                                it.find("[did='obj-comment']").html(obj.comment);
                            } else {
                                it.find("[did='comment']").prop("hidden", true);
                            }
                            it.find("[did='object-json']").html(JSON.stringify(obj, null, 4));

                            items += it.html();
                        }
                    }
                    $("#objects-list").html(items);
                    $("#amount-objects").html("Count results: " + (amountResults === 0 ? data.objects.length : amountResults));
                    saveCurrentState('#objects', url);
                };
                if (searchType === "all") {
                    if (type === "none" && $("#historyCheckbox").is(":checked") === true) {
                        let _res = getHistoryForObject("all", null);
                        $("#objects-list").html(_res.items);
                        $("#amount-objects").html("Count results: " + _res.amount);
                        saveCurrentState('#objects', url);
                    } else {
                        let obj = {
                            "type": type,
                            "limit": $("#limit-field").val()
                        };

                        $.getJSON("/api/objects", obj, function (data) {
                            funcProcResults(data, '/api/admin?tab=objects&search=' + type + '&type=' + searchType + '&history=' + $("#historyCheckbox").is(":checked") + '&limit=' + $("#limit-field").val());
                        });
                    }

                } else if (searchType === "id") {
                    let obj = {
                        "type": type,
                        "key": key
                    };
                    $.getJSON("/api/objects-by-id", obj, function (data) {
                        funcProcResults(data, '/api/admin?tab=objects&search=' + type + '&type=' + searchType + '&key=' + key + "&history=" + $("#historyCheckbox").is(":checked") + '&limit=' + $("#limit-field").val());
                    });
                } else if (searchType === "userId") {
                    let _res = getHistoryForObject("user", key);
                    $("#objects-list").html(_res.items);
                    $("#amount-objects").html("Count results: " + _res.amount);
                    saveCurrentState('#objects', '/api/admin?tab=objects&search=' + type + '&type=' + searchType + '&key=' + key + "&history=" + $("#historyCheckbox").is(":checked") + '&limit=' + $("#limit-field").val());
                } else if (searchType === "opHash") {
                    let _res = getHistoryForObject("operation", key);
                    $("#objects-list").html(_res.items);
                    $("#amount-objects").html("Count results: " + _res.amount);
                    saveCurrentState('#objects', '/api/admin?tab=objects&search=' + type + '&type=' + searchType + '&key=' + key + "&history=" + $("#historyCheckbox").is(":checked") + '&limit=' + $("#limit-field").val());
                } else {
                    let obj = {
                        "type": type,
                        "index": $("#search-type-list").val(),
                        "limit": $("#limit-field").val(),
                        "key": key
                    };
                    $.getJSON("/api/objects-by-index", obj, function (data) {
                        funcProcResults(data, '/api/admin?tab=objects&search=' + type + '&type=' + searchType + '&key=' + key + '&history=' + $("#historyCheckbox").is(":checked") + '&limit=' + $("#limit-field").val());
                    });
                }
            }
        });

        window.onpopstate = function (event) {
            if (window.history.state && history.state.idStorage) {
                if (history.state.tab === "#objects") {
                    $(".nav-tabs a[href=\""+history.state.tab+"\"]").tab('show');
                    document.getElementById("objects-list").innerHTML = sessionStorage.getItem(event.state.idStorage);
                    console.log(history.state);
                    $("#type-list").val(history.state.type).change();
                    setTimeout(function() {
                        $("#search-type-list").val(history.state.searchType).change();
                    }, 200);
                    $("#historyCheckbox").prop("checked", history.state.showHistory).prop("disabled", history.state.historyDisabled);
                    $("#limit-field").val(history.state.limit);
                    $("#search-key").val(history.state.key);
                    $("#amount-objects").text(history.state.countElements);
                } else if (history.state.tab === "#operations") {
                    $(".nav-tabs a[href=\""+history.state.tab+"\"]").tab('show');
                    document.getElementById("operations-list").innerHTML = sessionStorage.getItem(event.state.idStorage);
                    console.log(history.state);
                    if (!history.state.keyHidden) {
                        $("#operations-search-fields").show();
                        $("#input-search-operation-key").text(history.state.inputSearch);
                        $("#operations-key").val(history.state.keyValue);
                    } else {
                        $("#operations-search-fields").hide();
                        // $("#input-search-operation-key").hide();
                        // $("#operations-key").hide();
                    }
                    $("#operations-search").val(history.state.load);
                    $("#amount-operations").text(history.state.countElements);
                } else if (history.state.tab === "#blocks") {
                    $(".nav-tabs a[href=\""+history.state.tab+"\"]").tab('show');
                    document.getElementById("blocks-list").innerHTML = sessionStorage.getItem(event.state.idStorage);
                    $("#blocks-search").val(history.state.blockSearch);
                    if (!history.state.showInput) {
                        $("#block-from-fields").show();
                        $("#search-block-field").val(history.state.inputKey);
                        $("#block-limit-value").val(history.state.inputLimit);

                    } else {
                        $("#block-from-fields").hide();
                    }
                }
            }
        };

        $("#finish-edit-btn").click(function () {
            try {
                var newObject = editor.get();
                var res = deepDiffMapper.map(originObject, newObject);
                var path = "";
                var changeEdit = {};
                var currentEdit = {};
                deepDiffMapper.generateChangeCurrentObject(path, res, changeEdit, currentEdit);
                deepDiffMapper.generateEditOp(originObject, changeEdit, currentEdit);

                originObject = null;
                $("#editing-objects").hide();
                $("#stop-edit-objects").show();
                $("#add-edited-obj").show();
            } catch (e) {
                alert(e);
            }
        });

        $("#stop-edit-btn").click(function () {
            editor = null;
            originObject = null;
            $("#editing-objects").hide();
            $("#add-edited-obj").hide();
            $("#stop-edit-objects").hide();
            $("#json-display").hide();
        });

        var deepDiffMapper = function() {
            return {
                VALUE_CREATED: 'created',
                VALUE_UPDATED: 'updated',
                VALUE_DELETED: 'deleted',
                VALUE_UNCHANGED: 'unchanged',
                map: function(obj1, obj2) {
                    if (this.isFunction(obj1) || this.isFunction(obj2)) {
                        throw 'Invalid argument. Function given, object expected.';
                    }
                    if (this.isValue(obj1) || this.isValue(obj2)) {
                        var opType = this.compareValues(obj1, obj2);
                        if (opType === this.VALUE_UPDATED) {
                            return {
                                editType: opType,
                                old: (obj1 === undefined) ? obj2 : obj1,
                                new: (obj2 === undefined) ? obj1 : obj2
                            }
                        } else if (opType === this.VALUE_CREATED) {
                            return {
                                editType: opType,
                                new: (obj1 === undefined) ? obj2 : obj1
                            };
                        } else if (opType === this.VALUE_DELETED) {
                            return {
                                editType: opType,
                                old: (obj1 === undefined) ? obj2 : obj1
                            }
                        } else {
                            return {
                                editType :opType
                            }
                        }
                    }

                    var diff = {};
                    for (var key in obj1) {
                        if (this.isFunction(obj1[key])) {
                            continue;
                        }

                        var value2 = undefined;
                        if ('undefined' != typeof(obj2[key])) {
                            value2 = obj2[key];
                        }

                        diff[key] = this.map(obj1[key], value2);
                    }
                    for (var key in obj2) {
                        if (this.isFunction(obj2[key]) || ('undefined' != typeof(diff[key]))) {
                            continue;
                        }

                        diff[key] = this.map(undefined, obj2[key]);
                    }

                    return diff;

                },
                compareValues: function(value1, value2) {
                    if (value1 === value2) {
                        return this.VALUE_UNCHANGED;
                    }
                    if (this.isDate(value1) && this.isDate(value2) && value1.getTime() === value2.getTime()) {
                        return this.VALUE_UNCHANGED;
                    }
                    if ('undefined' == typeof(value1)) {
                        return this.VALUE_CREATED;
                    }
                    if ('undefined' == typeof(value2)) {
                        return this.VALUE_DELETED;
                    }

                    return this.VALUE_UPDATED;
                },
                generateChangeCurrentObject: function(path, obj, changeEdit, currentEdit) {
                    if (obj.hasOwnProperty("editType")) {
                        if (obj["editType"] === this.VALUE_CREATED) {
                            var setObj = {
                                set: obj["new"]
                            };
                            changeEdit[path] = setObj;
                        } else if (obj["editType"] === this.VALUE_DELETED) {
                            changeEdit[path] = "delete";
                            currentEdit[path] = obj["old"];
                        } else if (obj["editType"] === this.VALUE_UPDATED) {
                            var setObj = {
                                set: obj["new"]
                            };
                            changeEdit[path] = setObj;
                            currentEdit[path] = obj["old"];
                        }
                    } else {
                        for (var key in obj) {
                            if (key === "version") {
                                changeEdit[key] = "increment";
                            }
                            var mapObj = obj[key];
                            var path1;
                            var value = Number(key);
                            if (!isNaN(value)) {
                                path1 = path === "" ? key : (path + "[" + key + "]");
                            } else {
                                path1 = path === "" ? key : (path + "." + key);
                            }
                            this.generateChangeCurrentObject(path1, mapObj, changeEdit, currentEdit);
                        }
                    }
                },
                generateEditOp: function(obj, changeEdit, currentEdit) {
                    var listEdit = [
                        {
                            id: obj["id"],
                            change: changeEdit,
                            current: currentEdit
                        }
                    ];
                    var op = {
                        type: $("#type-list").val(),
                        edit: listEdit
                    };
                    editor.load(op);
                },
                isFunction: function(obj) {
                    return {}.toString.apply(obj) === '[object Function]';
                },
                isArray: function(obj) {
                    return {}.toString.apply(obj) === '[object Array]';
                },
                isObject: function(obj) {
                    return {}.toString.apply(obj) === '[object Object]';
                },
                isDate: function(obj) {
                    return {}.toString.apply(obj) === '[object Date]';
                },
                isValue: function(obj) {
                    return !this.isObject(obj) && !this.isArray(obj);
                }
            }
        }();

        $("#load-bot-stats-btn").click(function () {
            $.getJSON("/api/bot/stats")
                .done(function (data) {
                    var items = "";
                    for (var key in data) {
                        var obj = data[key];
                        items += "<br><li><b>Id</b>: " + obj.id;
                        items += "<br><b>API</b>: " + obj.api;
                        items += "<br><b>Version</b>: " + obj.version;
                        items += "<br><b>Started</b>: " + obj.started;
                        if ('botStats' in obj) {
                            items += "<br><b>Task description</b>: " + obj.botStats.taskDescription;
                            items += "<br><b>Task name</b>: " + obj.botStats.taskName;
                            items += "<br><b>Task count</b>: " + obj.botStats.taskCount;
                            items += "<br><b>Total tasks</b>: " + obj.botStats.total;
                            if (obj.botStats.taskCount === obj.botStats.total) {
                                items += "<span class=\"label label-primary\">Not enabled</span>";
                            } else {
                                items += "<div class=\"progress\">\n" +
                                    "<div class=\"progress-bar progress-bar-striped progress-bar-animated\" role=\"progressbar\" aria-valuenow=\"" + obj.botStats.progress + "\" aria-valuemin=\"0\" aria-valuemax=\"" + obj.botStats.total + "\" style=\"width: " + obj.botStats.progress + "%\"></div>\n" +
                                    "</div>";
                            }
                        }
                        items += "<br></li>";
                    };
                    $("#bot-list-stats").html(items);
                })
                .fail(function(xhr, status, error) { $("#result").html("ERROR: " + error); });
        });
        
        $("#refresh-bot-history-btn").click(function () {
            var botName = $(".modal-header #history-bot-name").val();
            showBotHistory(botName);
        });

        $("#update-settings").click(function () {
            var keyConfig = $("#config-list").val();
            if (globalConfig[keyConfig] !== $("#config-value").val() && keyConfig !== null) {
                var obj = {
                    key: keyConfig,
                    value: $("#config-value").val()
                };
                $.post("/api/mgmt/config", obj)
                    .done(function (data) {
                        $("#result").html("SUCCESS: " + data);
                        loadConfiguration();
                        setTimeout(function() {
                            $("#config-list").val(keyConfig).change();
                        }, 200);
                    })
                    .fail(function (xhr, status, error) {
                        $("#result").html("ERROR: " + error);
                    });
                $("#settings-warn-alert").show();
            } else {
                $("#result").html("ERROR: " + "Nothing to update");
            }
        });

       $("#show-add-new-preference-btn").click(function () {
          $("#add-new-preference").show();
          $("#show-add-new-preference-btn").hide();
       });

       $("#add-new-preference-btn").click(function () {
           var obj = {
               key: $("#new-preference-key").val(),
               value: $("#new-preference-value").val(),
               type: $("#new-preference-type").val(),
               restartIsNeeded: $("#new-preference-restart").val()
           };
           $.post("/api/mgmt/config", obj)
               .done(function (data) {
                   $("#result").html("SUCCESS: " + data);
                   loadConfiguration();
               })
               .fail(function (xhr, status, error) {
                   $("#result").html("ERROR: " + error);
               });
       });

       $("#cancel-new-preference-btn").click(function () {
           $("#add-new-preference").hide();
           $("#show-add-new-preference-btn").show();

       });

       $("#save-new-value-for-settings-btn").click(function () {
           var obj = {
               key: $("#settings-name").val(),
               value: $("#edit-preference-value").val(),
               type: $("#settings-type").text(),
           };
           $.post("/api/mgmt/config", obj)
               .done(function (data) {
                   $("#result").html("SUCCESS: " + data);
                   loadConfiguration();
               })
               .fail(function (xhr, status, error) {
                   $("#result").html("ERROR: " + error);
               });

           $("#settings-edit-modal .close").click();
       });

        $("#operations-search-btn").click(function () {
            var typeSearch = $("#operations-search").val();
            var key = $("#operations-key").val();

            if (typeSearch === "queue") {
                $.getJSON( "/api/queue", function( data ) {
                    showOperations(data, '/api/admin?tab=operations&load=' + typeSearch);
                    $("#amount-operations").hide();
                });
            } else if (typeSearch === "id") {
                $.getJSON("/api/ops-by-id?id=" + key, function (data) {
                    showOperations(data, '/api/admin?tab=operations&loadBy=' + typeSearch + '&key=' + key);
                    $("#amount-operations").show();
                })
            } else if (typeSearch === "blockId") {
                $.getJSON( "/api/ops-by-block-id?blockId=" + key, function( data ) {
                    showOperations(data, '/api/admin?tab=operations&loadBy=' + typeSearch + '&key=' + key);
                    $("#amount-operations").show();
                });
            } else { //blockHash
                $.getJSON( "/api/ops-by-block-hash?hash=" + key, function( data ) {
                    showOperations(data, '/api/admin?tab=operations&loadBy=' + typeSearch + '&key=' + key);
                    $("#amount-operations").show();
                });
            }
        });

        $("#block-load-btn").click(function () {
            var type = $("#blocks-search").val();
            var reqObj = {
               	depth: $("#block-limit-value").val()
            };
            if(type != "all") {
            	reqObj[type] = $("#search-block-field").val();
            }
            $.getJSON("/api/blocks", reqObj, function (data) {
                var items = processBlocksResult(data);
                $("#blocks-list").html(items);
                saveCurrentState("#blocks", "/api/admin?tab=blocks&search=" + type + "&limit=" + $("#block-limit-value").val());
            });
        });

        $("#add-file-btn").click(function () {
            var formData = new FormData();
            formData.append("file", $("#image-file")[0].files[0]);

            $.ajax({
                url: '/api/ipfs/image',
                data: formData,
                processData: false,
                contentType: false,
                type: 'POST',
                success: function(data) {
                    $("#result-add-image").html(data.toString());
                    loadData();
                },
                error: function (xhr, status, error) {
                    $("#result-add-image").html("ERROR: " + error);
                }
            });
        });

        $("#get-image-btn").click(function () {
            $("#image-link").attr("href", "/api/ipfs/image?hash=" + $("#get-image").val());
            $("#image-link").click();
        });

        $("#fix-ipfs-missing-images-btn").click(function () {
            $.post("/api/ipfs/mgmt/ipfs-maintenance")
                .done(function (data) {$("#result").html("SUCCESS: " + data); loadData(); loadFullIpfsStatus(); })
                .fail(function (xhr, status, error) { $("#result").html("ERROR: " + error); })
        });

        $("#fix-blc-missing-images-btn").click(function () {
            $.post("/api/ipfs/mgmt/clean-deprecated-ipfs")
                .done(function (data) {
                    $("#result").html("SUCCESS: " + data);
                    loadData();
                    loadFullIpfsStatus();
                })
                .fail(function (xhr, status, error) {
                    $("#result").html("ERROR: " + error);
                });
        });

        $("#laod-full-stats-btn").click(function () {
            loadFullIpfsStatus();
        });

        $("#signup-btn").click(function() {
            var obj = {
                "pwd":$("#signup-pwd").val(),
                "pwdOld":$("#signup-pwd-old").val(),
                "name":$("#signup-name").val(),
                "oauthProvider":$("#signup-oauth-p").val(),
                "oauthProviderOld":$("#signup-oauth-p-old").val(),
                "oauthId":$("#signup-oauth-id").val(),
                "oauthIdOld":$("#signup-oauth-id-old").val(),
                "algo":"EC",
                "privateKey":$("#signup-user-prk").val(),
                "privateKeyOld":$("#signup-user-prk-old").val(),
                "publicKey":$("#signup-user-pbk").val(),
                "publicKeyOld":$("#signup-user-pbk-old").val(),
                "userDetails":$("#signup-details").val()
            };
            $.post("/api/auth/signup", obj)
                .done(function(data){  $("#result").html(data); loadData(); })
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData(); });
        });

        $("#sign-btn").click(function() {
            var obj = {
                "json":$("#sign-json").val(),
                "name":$("#sign-name").val(),
                "pwd":$("#sign-pwd").val(),
                "privateKey":$("#sign-pk").val(),
                "dontSignByServer":$("#sign-by-server").is(':checked')
            };
            $.post("/api/auth/process-operation", obj)
                .done(function(data){  $("#result").html(data); loadData();})
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData();  });
        });
        $("#sign-add-btn").click(function() {
            var obj = {
                "name":$("#sign-name").val(),
                "pwd":$("#sign-pwd").val(),
                "privateKey":$("#sign-pk").val(),
                "addToQueue" : "true",
                "dontSignByServer":$("#sign-by-server").is(':checked')
            };
            var params = $.param(obj);
            var json = $("#sign-json").val();
            $.ajax({
                url: '/api/auth/process-operation?' + params,
                type: 'POST',
                data: json,
                contentType: 'application/json; charset=utf-8'
            }).done(function(data){  $("#result").html(data); loadData();})
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData();  });

            // $.post("/api/auth/process-operation", obj)
        });
        $("#add-edit-op-btn").click(function () {
            var obj = {
                "addToQueue" : "true",
                "dontSignByServer": false
            };
            var params = $.param(obj);
            var json = JSON.stringify(editor.get());
            $.ajax({
                url: '/api/auth/process-operation?' + params,
                type: 'POST',
                data: json,
                contentType: 'application/json; charset=utf-8'
            }).done(function(data){
                $("#result").html(data); loadData();  editor = null;
                $("#json-display").hide();$("#stop-edit-objects").hide();
                $("#add-edited-obj").hide()})
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); });
        });
        $("#login-btn").click(function() {
            var obj = {
                "name":$("#login-name").val(),
                "pwd":$("#login-pwd").val(),
                "edit":"true",
                "signupPrivateKey":$("#login-signup-key").val(),
                "oauthProvider":$("#login-oauth-p").val(),
                "oauthId":$("#login-oauth-id").val(),
                "loginPubKey":$("#login-public-key").val(),
                "loginAlgo":"EC",
                "userDetails": $("#login-details").val()
            };
            $.post("/api/auth/login", obj)
                .done(function(data){  $("#result").html(data); loadData();})
                .fail(function(xhr, status, error){  $("#result").html("ERROR: " + error); loadData();  });
        });
    });

    async function sha256(message) {
        // encode as UTF-8
        const msgBuffer = new TextEncoder('utf-8').encode(message);

        // hash the message
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);

        // convert ArrayBuffer to Array
        const hashArray = Array.from(new Uint8Array(hashBuffer));

        // convert bytes to hex string
        const hashHex = hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('');
        return hashHex;
    }

    $('input[type="checkbox"]').on('change', function() {
        $(this).siblings('input[type="checkbox"]').prop('checked', false);
    });

</script>

</html>